# RF028.1 ðŸ½ï¸ IntegraÃ§Ã£o com aplicativos de delivery para importaÃ§Ã£o de gastos

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a integraÃ§Ã£o com aplicativos de delivery (como iFood, Rappi, Uber Eats) para importaÃ§Ã£o
direta de gastos. Ao conectar a conta do aplicativo de delivery, o sistema pode automaticamente importar o histÃ³rico de
pedidos como transaÃ§Ãµes financeiras, preenchendo detalhes como valor, estabelecimento, data e categoria, simplificando o
registro e a categorizaÃ§Ã£o de despesas com alimentaÃ§Ã£o e delivery.

## ðŸ‘¥ Atores

- ðŸ‘¤ **UsuÃ¡rio**: O proprietÃ¡rio da conta no aplicativo de delivery que deseja integrar.
- ðŸ“¦ **Aplicativo de Delivery**: A plataforma que fornece o histÃ³rico de pedidos para importaÃ§Ã£o.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- O usuÃ¡rio deve ter uma conta ativa no aplicativo de delivery a ser integrado.
- A integraÃ§Ã£o com o aplicativo de delivery deve ser suportada pela nossa plataforma.
- O usuÃ¡rio deve conceder consentimento para o compartilhamento de dados do aplicativo de delivery.

## ðŸ”Œ Endpoints

- `POST /api/delivery-integrations/link` (Iniciar processo de vinculaÃ§Ã£o com delivery app)
- `GET /api/delivery-integrations/callback` (Endpoint de callback do delivery app)
- `GET /api/delivery-integrations/{integrationId}/sync` (Sincronizar gastos de uma integraÃ§Ã£o)
- `GET /api/users/{userId}/delivery-integrations` (Listar integraÃ§Ãµes de delivery)

## ðŸ“‹ Dados de IntegraÃ§Ã£o de Delivery

### InÃ­cio de VinculaÃ§Ã£o

| Campo           | Tipo     | ObrigatÃ³rio | DescriÃ§Ã£o                                                        | RestriÃ§Ãµes                                   |
|-----------------|----------|-------------|------------------------------------------------------------------|----------------------------------------------|
| `deliveryAppId` | `string` | âœ… Sim       | ID do aplicativo de delivery (ex: "IFOOD", "RAPPI").             | Deve ser um ID de aplicativo suportado.      |
| `redirectUrl`   | `string` | âœ… Sim       | URL para onde o delivery app redirecionarÃ¡ apÃ³s o consentimento. | Deve ser uma URL vÃ¡lida da nossa plataforma. |

### Dados Retornados pelo Callback (Exemplo)

| Campo               | Tipo     | DescriÃ§Ã£o                                                                         | RestriÃ§Ãµes                               |
|---------------------|----------|-----------------------------------------------------------------------------------|------------------------------------------|
| `authorizationCode` | `string` | CÃ³digo de autorizaÃ§Ã£o concedido pelo delivery app.                                | Gerado pelo delivery app.                |
| `state`             | `string` | Estado para prevenÃ§Ã£o de CSRF, deve corresponder ao gerado na requisiÃ§Ã£o inicial. | Gerado e validado pela nossa plataforma. |

### SincronizaÃ§Ã£o de Gastos (Exemplo de dados importados)

| Campo               | Tipo                | DescriÃ§Ã£o                                        | RestriÃ§Ãµes             |
|---------------------|---------------------|--------------------------------------------------|------------------------|
| `transactionId`     | `string`            | ID Ãºnico da transaÃ§Ã£o gerado pelo nosso sistema. | N/A                    |
| `originalId`        | `string`            | ID original do pedido no delivery app.           | N/A                    |
| `appSource`         | `string`            | Nome do aplicativo de delivery.                  | N/A                    |
| `description`       | `string`            | DescriÃ§Ã£o do pedido/gasto.                       | N/A                    |
| `amount`            | `number`            | Valor total do gasto.                            | Negativo para despesa. |
| `currency`          | `string`            | Moeda do gasto.                                  | N/A                    |
| `date`              | `string` (ISO 8601) | Data do pedido.                                  | Formato `YYYY-MM-DD`.  |
| `establishmentName` | `string`            | Nome do restaurante/loja.                        | N/A                    |
| `category`          | `string`            | Categoria sugerida (ex: "AlimentaÃ§Ã£o").          | N/A                    |

## ðŸ”„ Fluxo Principal - VinculaÃ§Ã£o com Aplicativo de Delivery

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant S as Nosso Sistema
    participant D as Aplicativo de Delivery
    U ->> S: 1. Inicia vinculaÃ§Ã£o de conta delivery (POST /api/delivery-integrations/link)
    S ->> D: 2. Redireciona U para a pÃ¡gina de autorizaÃ§Ã£o do Delivery App
    D ->> U: 3. U faz login e concede autorizaÃ§Ã£o
    D ->> S: 4. Redireciona para o callback com authorizationCode (GET /api/delivery-integrations/callback)
    S ->> D: 5. Troca authorizationCode por Access Token
    S ->> S: 6. Armazena Access Token e vincula integraÃ§Ã£o ao UsuÃ¡rio
    S ->> U: 7. Notifica U sobre sucesso da vinculaÃ§Ã£o
```

1. O UsuÃ¡rio acessa a seÃ§Ã£o de integraÃ§Ãµes em nossa plataforma e seleciona o aplicativo de delivery que deseja
   vincular (POST para `/api/delivery-integrations/link`).
2. Nossa plataforma gera um `state` e redireciona o UsuÃ¡rio para a pÃ¡gina de autorizaÃ§Ã£o do Aplicativo de Delivery.
3. O UsuÃ¡rio faz login no Aplicativo de Delivery e concede autorizaÃ§Ã£o para nossa plataforma acessar seus dados de
   pedidos.
4. O Aplicativo de Delivery redireciona o UsuÃ¡rio de volta para o `redirectUrl` de nossa plataforma (endpoint
   `/api/delivery-integrations/callback`), incluindo um `authorizationCode` e o `state`.
5. Nosso sistema recebe o `authorizationCode`, valida o `state`, e o troca por um Access Token (e possivelmente um
   Refresh Token) com o Aplicativo de Delivery.
6. O Access Token Ã© armazenado de forma segura e a integraÃ§Ã£o Ã© vinculada ao perfil do UsuÃ¡rio em nossa plataforma.
7. O sistema notifica o UsuÃ¡rio que a vinculaÃ§Ã£o foi bem-sucedida e que os gastos podem ser importados.

## ðŸ”„ Fluxo Principal - SincronizaÃ§Ã£o AutomÃ¡tica de Gastos

```mermaid
sequenceDiagram
    participant S as Nosso Sistema
    participant D as Aplicativo de Delivery
    S ->> S: 1. (Agendado/Gatilho) Inicia sincronizaÃ§Ã£o para integraÃ§Ãµes ativas
    S ->> D: 2. Solicita novos pedidos/gastos usando Access Token
    D -->> S: 3. Retorna histÃ³rico de pedidos
    S ->> S: 4. Processa, normaliza e categoriza dados de gastos
    S ->> S: 5. Registra novas transaÃ§Ãµes no perfil do UsuÃ¡rio
    S ->> U: 6. (Opcional) Notifica U sobre novos gastos importados
```

1. Periodicamente (ou acionado por eventos, como a vinculaÃ§Ã£o de uma nova conta), nosso sistema inicia a sincronizaÃ§Ã£o
   de dados para as integraÃ§Ãµes de delivery ativas (GET para `/api/delivery-integrations/{integrationId}/sync`).
2. Utilizando o Access Token armazenado, nosso sistema solicita o histÃ³rico de pedidos do UsuÃ¡rio ao Aplicativo de
   Delivery via sua API.
3. O Aplicativo de Delivery retorna os dados dos pedidos (valor, restaurante, data, itens, etc.) para nosso sistema.
4. Nosso sistema processa os dados, os normaliza para o formato de transaÃ§Ã£o interna, e tenta categorizar
   automaticamente o gasto (e.g., "AlimentaÃ§Ã£o"). Verifica duplicidade para evitar importar o mesmo pedido vÃ¡rias vezes.
5. As novas transaÃ§Ãµes sÃ£o registradas no banco de dados, associando-as ao perfil do UsuÃ¡rio.
6. O sistema pode enviar uma notificaÃ§Ã£o ao UsuÃ¡rio sobre a conclusÃ£o da sincronizaÃ§Ã£o e a disponibilidade de novos
   gastos importados.

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - ReautenticaÃ§Ã£o NecessÃ¡ria

1. Se o Access Token expirar ou for revogado, nosso sistema detecta um erro de autenticaÃ§Ã£o durante a sincronizaÃ§Ã£o.
2. O sistema notifica o UsuÃ¡rio que ele precisa reautenticar sua conta de delivery, redirecionando-o para o processo de
   consentimento novamente.

### âš ï¸ FA02 - Falha Parcial na ImportaÃ§Ã£o

1. Alguns pedidos podem falhar ao ser importados devido a dados inconsistentes ou erros temporÃ¡rios da API externa.
2. O sistema registra os erros, tenta reprocessar em uma prÃ³xima sincronizaÃ§Ã£o e notifica o UsuÃ¡rio sobre quaisquer
   lacunas ou dados ausentes.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - IntegraÃ§Ã£o NÃ£o Encontrada ou NÃ£o Pertencente ao UsuÃ¡rio

1. O `integrationId` especificado nÃ£o Ã© encontrado ou nÃ£o pertence ao usuÃ¡rio autenticado.
2. O sistema retorna uma resposta HTTP 404 Not Found.

### âš ï¸ FE02 - Aplicativo de Delivery IndisponÃ­vel

1. A API do Aplicativo de Delivery estÃ¡ fora do ar ou com problemas de conectividade.
2. Nosso sistema tenta novamente apÃ³s um tempo e, se a falha persistir, notifica o UsuÃ¡rio sobre a indisponibilidade.

### âš ï¸ FE03 - Dados Inconsistentes do Aplicativo de Delivery

1. O Aplicativo de Delivery envia dados de pedido que nÃ£o correspondem ao esperado pelo nosso sistema.
2. O sistema tenta sanitizar os dados ou os ignora, registra o erro e pode notificar a equipe de suporte.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para Iniciar VinculaÃ§Ã£o com iFood (Frontend -> Backend)

```http
POST /api/delivery-integrations/link HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "deliveryAppId": "IFOOD",
  "redirectUrl": "https://app.metakyasshu.com/delivery-callback"
}
```

### Exemplo de Retorno do Callback do Aplicativo de Delivery (para o nosso Backend)

```http
GET /api/delivery-integrations/callback?code=AUTH_CODE_DELIVERY_123&state=STATE_VALUE_XYZ HTTP/1.1
Host: api.metakyasshu.com
```

### Exemplo de Dados de Gasto Sincronizado do iFood

```json
{
  "originalId": "order_ifood_456789",
  "appSource": "IFOOD",
  "description": "Pedido #456789 - Restaurante Sabor Oriental",
  "amount": -85.90,
  "currency": "BRL",
  "date": "2024-07-21",
  "establishmentName": "Restaurante Sabor Oriental",
  "category": "AlimentaÃ§Ã£o"
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 