# RF026.2 ðŸ“± Scanner de notas fiscais para transaÃ§Ãµes

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite o uso de scanner de notas fiscais (fÃ­sicas ou digitais, como PDFs) para registro rÃ¡pido de
transaÃ§Ãµes. Ao escanear uma nota fiscal, o sistema utiliza OCR (Optical Character Recognition) e inteligÃªncia artificial
para extrair automaticamente informaÃ§Ãµes como valor total, itens comprados, data, estabelecimento e CNPJ, preenchendo os
campos da transaÃ§Ã£o e facilitando o controle de gastos e a prestaÃ§Ã£o de contas.

## ðŸ‘¥ Atores

- ðŸ‘¤ **UsuÃ¡rio**: O indivÃ­duo que escaneia ou faz upload de uma nota fiscal.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- O dispositivo do usuÃ¡rio deve ter uma cÃ¢mera funcional (para notas fÃ­sicas) ou o usuÃ¡rio deve ter um arquivo de nota
  fiscal digital para upload.
- A nota fiscal deve ser legÃ­vel e conter informaÃ§Ãµes estruturadas para extraÃ§Ã£o.

## ðŸ”Œ Endpoints

- `POST /api/transactions/invoice-scan` (Upload/Processar Nota Fiscal e Sugerir TransaÃ§Ã£o)

## ðŸ“‹ Dados de Processamento de Nota Fiscal

| Campo       | Tipo              | ObrigatÃ³rio | DescriÃ§Ã£o                                 | RestriÃ§Ãµes                          |
|-------------|-------------------|-------------|-------------------------------------------|-------------------------------------|
| `imageData` | `string` (Base64) | Condicional | Imagem da nota fiscal em Base64.          | ObrigatÃ³rio se nÃ£o for `pdfData`.   |
| `pdfData`   | `string` (Base64) | Condicional | ConteÃºdo do PDF da nota fiscal em Base64. | ObrigatÃ³rio se nÃ£o for `imageData`. |

## ðŸ“‹ Dados de SaÃ­da (SugestÃ£o de TransaÃ§Ã£o)

| Campo                  | Tipo     | DescriÃ§Ã£o                                                | RestriÃ§Ãµes                                                                                 |
|------------------------|----------|----------------------------------------------------------|--------------------------------------------------------------------------------------------|
| `suggestedTransaction` | `object` | Objeto JSON com os detalhes da transaÃ§Ã£o prÃ©-preenchida. | Pode incluir `amount`, `description`, `establishmentName`, `cnpj`, `date`, `items`, etc.   |
| `status`               | `string` | Status do processamento.                                 | Valores: `SUCCESS`, `INVALID_IMAGE_OR_PDF`, `PROCESSING_ERROR`, `NO_FINANCIAL_DATA_FOUND`. |
| `message`              | `string` | Mensagem descritiva do resultado.                        | N/A                                                                                        |

## ðŸ”„ Fluxo Principal

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant A as Aplicativo
    participant S as Sistema
    U ->> A: 1. Abre a funcionalidade de scanner de notas fiscais
    A ->> U: 2. Oferece opÃ§Ã£o de escanear (cÃ¢mera) ou fazer upload (arquivo)
    U ->> A: 3. Escaneia ou faz upload da nota fiscal
    A ->> S: 4. Envia a imagem/PDF da nota fiscal para processamento (POST /api/transactions/invoice-scan)
    S ->> S: 5. Realiza OCR e extraÃ§Ã£o de dados financeiros
    S ->> A: 6. Retorna uma sugestÃ£o de transaÃ§Ã£o prÃ©-preenchida
    A ->> U: 7. Exibe a tela de confirmaÃ§Ã£o de transaÃ§Ã£o com os campos preenchidos
    U ->> A: 8. (Opcional) Edita ou confirma a transaÃ§Ã£o
    A ->> S: 9. Envia a transaÃ§Ã£o finalizada (para RF relevante, ex: criaÃ§Ã£o de transaÃ§Ã£o)
    S ->> A: 10. Retorna confirmaÃ§Ã£o de transaÃ§Ã£o registrada
```

1. O UsuÃ¡rio abre a funcionalidade de scanner de notas fiscais no aplicativo.
2. O aplicativo oferece ao usuÃ¡rio as opÃ§Ãµes de escanear uma nota fiscal com a cÃ¢mera do dispositivo ou fazer o upload
   de um arquivo de imagem/PDF.
3. O UsuÃ¡rio escaneia a nota fiscal ou seleciona um arquivo para upload.
4. O aplicativo envia a imagem (em Base64) ou o conteÃºdo do PDF (em Base64) da nota fiscal para o endpoint
   `POST /api/transactions/invoice-scan`.
5. O sistema backend realiza OCR na imagem/PDF para extrair o texto e, em seguida, utiliza algoritmos de processamento
   de linguagem natural e inteligÃªncia artificial para identificar e extrair dados financeiros relevantes (ex: valor
   total, data, CNPJ, nome do estabelecimento, itens).
6. O sistema retorna uma sugestÃ£o de objeto de transaÃ§Ã£o prÃ©-preenchida com os dados extraÃ­dos para o aplicativo.
7. O aplicativo exibe uma tela de confirmaÃ§Ã£o da transaÃ§Ã£o, com os campos preenchidos automaticamente com os dados da
   nota fiscal.
8. O UsuÃ¡rio pode revisar, editar os campos (se necessÃ¡rio, corrigir erros de OCR) e confirmar a transaÃ§Ã£o.
9. O aplicativo envia a transaÃ§Ã£o finalizada para o endpoint apropriado (e.g., `POST /api/transactions`).
10. O sistema registra a transaÃ§Ã£o e retorna uma confirmaÃ§Ã£o de sucesso.

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - ExtraÃ§Ã£o Parcial de Dados

1. Se o OCR ou a IA nÃ£o conseguirem extrair todos os dados da nota fiscal (e.g., descriÃ§Ã£o ilegÃ­vel, valor faltando).
2. O sistema preenche os campos que conseguiu extrair e deixa os restantes em branco ou com sugestÃµes genÃ©ricas.
3. O aplicativo destaca os campos vazios ou com sugestÃµes para que o usuÃ¡rio possa preenchÃª-los manualmente.

### âš ï¸ FA02 - ClassificaÃ§Ã£o AutomÃ¡tica de Categoria

1. ApÃ³s a extraÃ§Ã£o dos itens ou da descriÃ§Ã£o da nota, o sistema tenta categorizar automaticamente a transaÃ§Ã£o (e.g., "
   Supermercado" para compras de mercado).
2. O `suggestedTransaction` inclui uma categoria sugerida, que o usuÃ¡rio pode aceitar ou modificar.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Imagem/PDF InvÃ¡lido ou IlegÃ­vel

1. O arquivo enviado nÃ£o Ã© uma imagem/PDF vÃ¡lido, estÃ¡ corrompido, ou a qualidade da imagem Ã© muito baixa para OCR.
2. O sistema retorna um `status: INVALID_IMAGE_OR_PDF` e uma mensagem de erro.
3. O aplicativo exibe uma mensagem de erro ao usuÃ¡rio e solicita uma imagem/PDF de melhor qualidade ou que tente
   novamente.

### âš ï¸ FE02 - Nenhuma InformaÃ§Ã£o Financeira Encontrada

1. O sistema consegue processar a imagem/PDF, mas nÃ£o detecta nenhuma informaÃ§Ã£o financeira estruturada (e.g., nÃ£o Ã© uma
   nota fiscal, mas um documento comum).
2. O sistema retorna um `status: NO_FINANCIAL_DATA_FOUND`.
3. O aplicativo informa ao usuÃ¡rio que nenhum dado relevante foi encontrado e sugere a entrada manual.

### âš ï¸ FE03 - Erro no ServiÃ§o de OCR/IA

1. O backend enfrenta um erro ao se comunicar com o serviÃ§o de OCR/IA ou durante o processamento interno.
2. O sistema retorna um `status: PROCESSING_ERROR`.
3. O aplicativo informa ao usuÃ¡rio sobre um erro interno e sugere que tente novamente ou insira os dados manualmente.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para Processar uma Imagem de Nota Fiscal (Base64 abreviado para exemplo)

```http
POST /api/transactions/invoice-scan HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "imageData": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFB..." 
  // ConteÃºdo real da imagem em base64 seria muito mais longo
}
```

### Exemplo de Resposta (SugestÃ£o de TransaÃ§Ã£o de Nota Fiscal)

```json
{
  "suggestedTransaction": {
    "type": "EXPENSE",
    "amount": 125.75,
    "currency": "BRL",
    "description": "Compras no Supermercado",
    "establishmentName": "SUPERMERCADO NOVO LTDA",
    "cnpj": "12.345.678/0001-90",
    "date": "2024-07-20",
    "items": [
      { "name": "Arroz 5kg", "quantity": 1, "price": 25.00 },
      { "name": "FeijÃ£o 1kg", "quantity": 2, "price": 8.50 },
      { "name": "Leite 1L", "quantity": 4, "price": 5.25 }
    ],
    "rawInvoiceData": "[ConteÃºdo textual extraÃ­do da nota fiscal]"
  },
  "status": "SUCCESS",
  "message": "Nota fiscal processada com sucesso. TransaÃ§Ã£o sugerida."
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 