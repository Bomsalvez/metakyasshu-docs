# RF027.3 ðŸ“¥ ImportaÃ§Ã£o de extratos PDF

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a importaÃ§Ã£o de extratos bancÃ¡rios no formato PDF. Utilizando tecnologias de OCR (Optical
Character Recognition) e inteligÃªncia artificial, o sistema extrai as transaÃ§Ãµes e saldos do documento PDF,
convertendo-os em dados estruturados que podem ser importados para as contas do usuÃ¡rio na plataforma. Isso oferece uma
maneira de automatizar a entrada de dados para usuÃ¡rios que sÃ³ possuem extratos em PDF.

## ðŸ‘¥ Atores

- ðŸ‘¤ **UsuÃ¡rio**: O indivÃ­duo que possui o extrato bancÃ¡rio em PDF e deseja importÃ¡-lo para a plataforma.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- O usuÃ¡rio deve ter um arquivo PDF de extrato bancÃ¡rio vÃ¡lido e legÃ­vel.
- O usuÃ¡rio deve ter uma conta bancÃ¡ria correspondente registrada na plataforma para associar o extrato.

## ðŸ”Œ Endpoints

- `POST /api/accounts/{accountId}/import/pdf` (Importar extrato PDF para uma conta)

## ðŸ“‹ Dados de ImportaÃ§Ã£o de Extrato PDF

| Campo        | Tipo              | ObrigatÃ³rio | DescriÃ§Ã£o                                 | RestriÃ§Ãµes                                             |
|--------------|-------------------|-------------|-------------------------------------------|--------------------------------------------------------|
| `accountId`  | `string`          | âœ… Sim       | ID Ãºnico da conta bancÃ¡ria na plataforma. | Deve ser um ID de conta vÃ¡lido e existente do usuÃ¡rio. |
| `pdfContent` | `string` (Base64) | âœ… Sim       | ConteÃºdo do arquivo PDF em Base64.        | Deve ser um PDF vÃ¡lido e legÃ­vel.                      |

## ðŸ“‹ Dados de SaÃ­da (Status da ImportaÃ§Ã£o)

| Campo                        | Tipo     | DescriÃ§Ã£o                                                | RestriÃ§Ãµes                                                                                       |
|------------------------------|----------|----------------------------------------------------------|--------------------------------------------------------------------------------------------------|
| `status`                     | `string` | Status da importaÃ§Ã£o.                                    | Valores: `SUCCESS`, `INVALID_PDF`, `ACCOUNT_NOT_FOUND`, `NO_DATA_EXTRACTED`, `PROCESSING_ERROR`. |
| `importedTransactionsCount`  | `number` | NÃºmero de transaÃ§Ãµes importadas com sucesso.             | N/A                                                                                              |
| `duplicateTransactionsCount` | `number` | NÃºmero de transaÃ§Ãµes duplicadas encontradas e ignoradas. | N/A                                                                                              |
| `message`                    | `string` | Mensagem descritiva do resultado da importaÃ§Ã£o.          | N/A                                                                                              |
| `errors`                     | `array`  | Lista de erros encontrados durante a importaÃ§Ã£o.         | N/A                                                                                              |

## ðŸ”„ Fluxo Principal

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant A as Aplicativo
    participant S as Sistema
    U ->> A: 1. Seleciona opÃ§Ã£o de importar extrato PDF para uma conta
    A ->> U: 2. Solicita upload do arquivo PDF
    U ->> A: 3. Faz upload do arquivo PDF
    A ->> S: 4. Envia o conteÃºdo do arquivo PDF para processamento (POST /api/accounts/{accountId}/import/pdf)
    S ->> S: 5. Realiza OCR e extraÃ§Ã£o de dados de transaÃ§Ã£o do PDF
    S ->> S: 6. Valida dados extraÃ­dos, verifica duplicidade e registra novas transaÃ§Ãµes
    S ->> A: 7. Retorna o status da importaÃ§Ã£o com contagem de transaÃ§Ãµes
    A ->> U: 8. Exibe resumo da importaÃ§Ã£o (sucesso, duplicadas, erros)
```

1. O UsuÃ¡rio acessa a seÃ§Ã£o de contas bancÃ¡rias e seleciona a opÃ§Ã£o de importar extrato PDF para uma conta especÃ­fica (
   `accountId`).
2. O aplicativo solicita que o usuÃ¡rio selecione e faÃ§a o upload de um arquivo PDF de extrato bancÃ¡rio de seu
   dispositivo.
3. O UsuÃ¡rio seleciona e faz o upload do arquivo PDF.
4. O aplicativo lÃª o conteÃºdo do arquivo PDF e o envia em Base64 para o endpoint
   `POST /api/accounts/{accountId}/import/pdf`.
5. O sistema backend recebe o conteÃºdo do PDF, realiza OCR para extrair o texto e utiliza inteligÃªncia artificial para
   identificar e extrair as transaÃ§Ãµes, valores, datas, descriÃ§Ãµes e saldos da conta. O sistema tenta identificar o
   formato do extrato para otimizar a extraÃ§Ã£o.
6. Os dados extraÃ­dos sÃ£o validados e comparados com as transaÃ§Ãµes existentes na `accountId` para evitar duplicidade.
   TransaÃ§Ãµes jÃ¡ existentes sÃ£o ignoradas.
7. O sistema registra as novas transaÃ§Ãµes no banco de dados, associando-as Ã  `accountId` do usuÃ¡rio, e atualiza o saldo
   da conta com base nas transaÃ§Ãµes importadas.
8. O sistema retorna uma resposta HTTP 200 OK contendo um resumo da importaÃ§Ã£o, incluindo o `status`,
   `importedTransactionsCount`, `duplicateTransactionsCount` e `message`.
9. O aplicativo exibe ao usuÃ¡rio um relatÃ³rio da importaÃ§Ã£o, informando quantas transaÃ§Ãµes foram importadas, quantas
   foram duplicadas e quaisquer erros que ocorreram.

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - Ajuste Manual PÃ³s-ImportaÃ§Ã£o

1. Se a extraÃ§Ã£o de dados for imprecisa (devido a PDFs complexos ou digitalizaÃ§Ãµes de baixa qualidade), o sistema pode
   marcar algumas transaÃ§Ãµes para revisÃ£o manual.
2. O usuÃ¡rio Ã© notificado e pode acessar uma interface para corrigir ou categorizar manualmente as transaÃ§Ãµes que
   apresentaram problemas.

### âš ï¸ FA02 - Processamento AssÃ­ncrono

1. Para PDFs grandes ou complexos que exigem mais tempo de processamento, a importaÃ§Ã£o pode ser realizada em segundo
   plano.
2. O sistema retorna um status inicial de `PROCESSING` e notifica o usuÃ¡rio quando a importaÃ§Ã£o estiver concluÃ­da,
   atravÃ©s de notificaÃ§Ã£o no aplicativo ou e-mail.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Conta BancÃ¡ria NÃ£o Encontrada ou NÃ£o Pertencente ao UsuÃ¡rio

1. O `accountId` especificado na requisiÃ§Ã£o nÃ£o Ã© encontrado ou nÃ£o pertence ao usuÃ¡rio autenticado.
2. O sistema retorna uma resposta HTTP 404 Not Found.

### âš ï¸ FE02 - Arquivo PDF InvÃ¡lido/IlegÃ­vel

1. O `pdfContent` nÃ£o Ã© um PDF vÃ¡lido, estÃ¡ corrompido, Ã© uma imagem de baixa qualidade dentro do PDF, ou o texto nÃ£o Ã©
   selecionÃ¡vel.
2. O sistema retorna um `status: INVALID_PDF` e uma mensagem de erro.

### âš ï¸ FE03 - Nenhuma InformaÃ§Ã£o Financeira ExtraÃ­da

1. O sistema consegue processar o PDF, mas nÃ£o identifica dados de extrato bancÃ¡rio (e.g., Ã© um PDF de um documento
   comum, nÃ£o um extrato).
2. O sistema retorna um `status: NO_DATA_EXTRACTED`.

### âš ï¸ FE04 - Erro no ServiÃ§o de OCR/IA

1. O backend enfrenta um erro ao se comunicar com o serviÃ§o de OCR/IA ou durante o processamento interno da extraÃ§Ã£o de
   dados.
2. O sistema retorna um `status: PROCESSING_ERROR` e uma lista de `errors` detalhando as falhas especÃ­ficas.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para Importar um Extrato PDF (conteÃºdo Base64 abreviado)

```http
POST /api/accounts/acc_xyz123/import/pdf HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "accountId": "acc_xyz123",
  "pdfContent": "JVBERi0xLjQKJcOkw..."
  // ConteÃºdo real do PDF em base64 seria muito mais longo
}
```

### Exemplo de Resposta de Sucesso

```json
{
  "status": "SUCCESS",
  "importedTransactionsCount": 75,
  "duplicateTransactionsCount": 15,
  "message": "Extrato PDF importado com sucesso. 75 novas transaÃ§Ãµes adicionadas, 15 duplicadas ignoradas."
}
```

### Exemplo de Resposta com Erro (PDF InvÃ¡lido)

```json
{
  "status": "INVALID_PDF",
  "importedTransactionsCount": 0,
  "duplicateTransactionsCount": 0,
  "message": "O arquivo PDF fornecido Ã© invÃ¡lido ou estÃ¡ corrompido.",
  "errors": ["Erro ao abrir o arquivo PDF."]
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 