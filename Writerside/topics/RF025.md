# RF025 ðŸ¦ IntegraÃ§Ã£o com Open Banking

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a integraÃ§Ã£o com Open Banking para sincronizaÃ§Ã£o automÃ¡tica de dados bancÃ¡rios. Os usuÃ¡rios
podem conectar suas contas bancÃ¡rias Ã  plataforma para importar transaÃ§Ãµes, saldos e outras informaÃ§Ãµes financeiras de
forma segura e automatizada, eliminando a necessidade de entrada manual de dados e fornecendo uma visÃ£o financeira
completa e atualizada.

## ðŸ‘¥ Atores

- ðŸ‘¤ **UsuÃ¡rio**: O proprietÃ¡rio da conta bancÃ¡ria que deseja integrar com o Open Banking.
- ðŸ›ï¸ **InstituiÃ§Ã£o Financeira**: O banco ou outra instituiÃ§Ã£o que expÃµe os dados via Open Banking.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- A InstituiÃ§Ã£o Financeira do usuÃ¡rio deve participar do ecossistema Open Banking e estar habilitada para integraÃ§Ã£o com
  a nossa plataforma.
- O usuÃ¡rio deve conceder consentimento para o compartilhamento de dados via Open Banking.

## ðŸ”Œ Endpoints

- `POST /api/open-banking/link` (Iniciar processo de vinculaÃ§Ã£o)
- `GET /api/open-banking/callback` (Endpoint de callback do Open Banking)
- `GET /api/accounts/{accountId}/transactions/sync` (Sincronizar transaÃ§Ãµes de uma conta)
- `GET /api/users/{userId}/open-banking/connected-accounts` (Listar contas conectadas)

## ðŸ“‹ Dados de IntegraÃ§Ã£o Open Banking

### InÃ­cio de VinculaÃ§Ã£o

| Campo         | Tipo     | ObrigatÃ³rio | DescriÃ§Ã£o                                                        | RestriÃ§Ãµes                                   |
|---------------|----------|-------------|------------------------------------------------------------------|----------------------------------------------|
| `bankId`      | `string` | âœ… Sim       | ID da instituiÃ§Ã£o financeira.                                    | Deve ser um ID de banco vÃ¡lido e suportado.  |
| `redirectUrl` | `string` | âœ… Sim       | URL para onde o Open Banking redirecionarÃ¡ apÃ³s o consentimento. | Deve ser uma URL vÃ¡lida da nossa plataforma. |

### Dados Retornados pelo Callback (Exemplo)

| Campo               | Tipo     | DescriÃ§Ã£o                                                                         | RestriÃ§Ãµes                               |
|---------------------|----------|-----------------------------------------------------------------------------------|------------------------------------------|
| `authorizationCode` | `string` | CÃ³digo de autorizaÃ§Ã£o concedido pelo Open Banking.                                | Gerado pela instituiÃ§Ã£o financeira.      |
| `state`             | `string` | Estado para prevenÃ§Ã£o de CSRF, deve corresponder ao gerado na requisiÃ§Ã£o inicial. | Gerado e validado pela nossa plataforma. |

### SincronizaÃ§Ã£o de TransaÃ§Ãµes (Exemplo de dados importados)

| Campo           | Tipo                | DescriÃ§Ã£o                           | RestriÃ§Ãµes                                         |
|-----------------|---------------------|-------------------------------------|----------------------------------------------------|
| `transactionId` | `string`            | ID Ãºnico da transaÃ§Ã£o no banco.     | N/A                                                |
| `accountId`     | `string`            | ID da conta bancÃ¡ria associada.     | N/A                                                |
| `description`   | `string`            | DescriÃ§Ã£o da transaÃ§Ã£o.             | N/A                                                |
| `amount`        | `number`            | Valor da transaÃ§Ã£o.                 | Pode ser positivo (receita) ou negativo (despesa). |
| `currency`      | `string`            | Moeda da transaÃ§Ã£o.                 | N/A                                                |
| `date`          | `string` (ISO 8601) | Data da transaÃ§Ã£o.                  | Formato `YYYY-MM-DD`.                              |
| `type`          | `string`            | Tipo de transaÃ§Ã£o (dÃ©bito/crÃ©dito). | Ex: `DEBIT`, `CREDIT`.                             |
| `category`      | `string`            | Categoria sugerida (se disponÃ­vel). | N/A                                                |

## ðŸ”„ Fluxo Principal - VinculaÃ§Ã£o de Conta BancÃ¡ria

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant S as Nosso Sistema
    participant O as Sistema Open Banking
    U ->> S: 1. Inicia vinculaÃ§Ã£o de conta (POST /api/open-banking/link com bankId)
    S ->> O: 2. Redireciona U para a pÃ¡gina de consentimento da InstituiÃ§Ã£o Financeira
    O ->> U: 3. U concede consentimento
    O ->> S: 4. Redireciona para o callback com authorizationCode (GET /api/open-banking/callback)
    S ->> O: 5. Troca authorizationCode por Access Token
    S ->> S: 6. Armazena Access Token e vincula conta ao UsuÃ¡rio
    S ->> U: 7. Notifica U sobre sucesso da vinculaÃ§Ã£o
```

1. O UsuÃ¡rio seleciona sua InstituiÃ§Ã£o Financeira em nossa plataforma e inicia o processo de vinculaÃ§Ã£o (POST para
   `/api/open-banking/link`).
2. Nossa plataforma gera um `state` e redireciona o UsuÃ¡rio para a pÃ¡gina de consentimento da InstituiÃ§Ã£o Financeira (
   via Open Banking).
3. O UsuÃ¡rio faz login na InstituiÃ§Ã£o Financeira e concede consentimento para o compartilhamento de dados com nossa
   plataforma.
4. A InstituiÃ§Ã£o Financeira redireciona o UsuÃ¡rio de volta para o `redirectUrl` de nossa plataforma (endpoint
   `/api/open-banking/callback`), incluindo um `authorizationCode` e o `state`.
5. Nosso sistema recebe o `authorizationCode`, valida o `state`, e o troca por um Access Token (e possivelmente um
   Refresh Token) com a InstituiÃ§Ã£o Financeira.
6. O Access Token Ã© armazenado de forma segura e a conta bancÃ¡ria Ã© vinculada ao perfil do UsuÃ¡rio em nossa plataforma.
7. O sistema notifica o UsuÃ¡rio que a vinculaÃ§Ã£o foi bem-sucedida e que os dados podem ser sincronizados.

## ðŸ”„ Fluxo Principal - SincronizaÃ§Ã£o AutomÃ¡tica de Dados

```mermaid
sequenceDiagram
    participant S as Nosso Sistema
    participant O as Sistema Open Banking
    S ->> S: 1. (Agendado/Gatilho) Inicia sincronizaÃ§Ã£o para contas conectadas
    S ->> O: 2. Solicita novas transaÃ§Ãµes/saldos usando Access Token
    O -->> S: 3. Retorna dados financeiros (transaÃ§Ãµes, saldos)
    S ->> S: 4. Processa e categoriza dados
    S ->> S: 5. Atualiza o perfil financeiro do UsuÃ¡rio
    S ->> U: 6. (Opcional) Notifica U sobre novos dados
```

1. Periodicamente (ou acionado por eventos), nosso sistema inicia a sincronizaÃ§Ã£o de dados para as contas vinculadas via
   Open Banking (GET para `/api/accounts/{accountId}/transactions/sync`).
2. Utilizando o Access Token armazenado, nosso sistema solicita as Ãºltimas transaÃ§Ãµes e/ou saldos da InstituiÃ§Ã£o
   Financeira via API do Open Banking.
3. A InstituiÃ§Ã£o Financeira retorna os dados financeiros para nosso sistema.
4. Nosso sistema processa os dados, categoriza as transaÃ§Ãµes (se possÃ­vel automaticamente) e os integra ao perfil
   financeiro do UsuÃ¡rio.
5. Os saldos das contas sÃ£o atualizados e novas transaÃ§Ãµes sÃ£o registradas, evitando duplicidade.
6. O sistema pode enviar uma notificaÃ§Ã£o ao UsuÃ¡rio sobre a conclusÃ£o da sincronizaÃ§Ã£o e a disponibilidade de novos
   dados.

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - ReautenticaÃ§Ã£o NecessÃ¡ria

1. Se o Access Token expirar ou for revogado, nosso sistema detecta um erro de autenticaÃ§Ã£o durante a sincronizaÃ§Ã£o.
2. O sistema notifica o UsuÃ¡rio que ele precisa reautenticar sua conta bancÃ¡ria via Open Banking, redirecionando-o para
   o processo de consentimento novamente.

### âš ï¸ FA02 - Falha Parcial na SincronizaÃ§Ã£o

1. Algumas transaÃ§Ãµes podem falhar ao ser importadas devido a dados inconsistentes ou erros temporÃ¡rios da API externa.
2. O sistema registra os erros, tenta reprocessar em uma prÃ³xima sincronizaÃ§Ã£o e notifica o UsuÃ¡rio sobre quaisquer
   lacunas ou dados ausentes.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Consentimento Negado

1. O UsuÃ¡rio nega o consentimento na pÃ¡gina da InstituiÃ§Ã£o Financeira.
2. A InstituiÃ§Ã£o Financeira redireciona para o callback com um erro ou sem o `authorizationCode`.
3. Nosso sistema detecta a falha e notifica o UsuÃ¡rio que a vinculaÃ§Ã£o nÃ£o pÃ´de ser concluÃ­da.

### âš ï¸ FE02 - InstituiÃ§Ã£o Financeira IndisponÃ­vel

1. A API do Open Banking da InstituiÃ§Ã£o Financeira estÃ¡ fora do ar ou com problemas de conectividade.
2. Nosso sistema tenta novamente apÃ³s um tempo e, se a falha persistir, notifica o UsuÃ¡rio sobre a indisponibilidade.

### âš ï¸ FE03 - Dados Inconsistentes da InstituiÃ§Ã£o Financeira

1. A InstituiÃ§Ã£o Financeira envia dados que nÃ£o correspondem ao esperado pelo nosso sistema (e.g., formato de data
   incorreto, campos obrigatÃ³rios ausentes).
2. O sistema tenta sanitizar os dados ou os ignora, registra o erro e pode notificar a equipe de suporte para
   investigaÃ§Ã£o.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para Iniciar VinculaÃ§Ã£o de Conta (Frontend -> Backend)

```http
POST /api/open-banking/link HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "bankId": "bank_bradesco",
  "redirectUrl": "https://app.metakyasshu.com/open-banking/callback"
}
```

### Exemplo de Retorno do Callback do Open Banking (para o nosso Backend)

```http
GET /api/open-banking/callback?code=AUTH_CODE_XYZ&state=STATE_VALUE_ABC HTTP/1.1
Host: api.metakyasshu.com
```

### RequisiÃ§Ã£o HTTP para ForÃ§ar SincronizaÃ§Ã£o de TransaÃ§Ãµes para uma Conta Conectada

```http
GET /api/accounts/acc_123def/transactions/sync HTTP/1.1
Host: api.metakyasshu.com
```

### Exemplo de Dados de TransaÃ§Ã£o Sincronizada

```json
{
  "transactionId": "trn_bank456",
  "accountId": "acc_123def",
  "description": "COMPRA SUPERMERCADO ABC",
  "amount": -75.50,
  "currency": "BRL",
  "date": "2024-07-18",
  "type": "DEBIT",
  "category": "AlimentaÃ§Ã£o"
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 