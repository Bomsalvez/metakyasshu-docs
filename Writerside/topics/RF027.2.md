# RF027.2 ðŸ“¥ ImportaÃ§Ã£o de extratos CSV

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a importaÃ§Ã£o de extratos bancÃ¡rios no formato CSV (Comma Separated Values). Os usuÃ¡rios
podem carregar seus arquivos CSV e mapear as colunas para os campos de transaÃ§Ã£o da plataforma, oferecendo uma forma
flexÃ­vel de importar dados financeiros de diversas fontes, mesmo sem suporte a OFX ou Open Banking.

## ðŸ‘¥ Atores

- ðŸ‘¤ **UsuÃ¡rio**: O indivÃ­duo que possui o extrato CSV e deseja importÃ¡-lo para a plataforma.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- O usuÃ¡rio deve ter um arquivo CSV contendo dados de transaÃ§Ãµes.
- O usuÃ¡rio deve ter uma conta bancÃ¡ria correspondente registrada na plataforma para associar o extrato.

## ðŸ”Œ Endpoints

- `POST /api/accounts/{accountId}/import/csv` (Importar extrato CSV para uma conta)
- `GET /api/import-templates/csv` (Obter templates de mapeamento de colunas CSV)

## ðŸ“‹ Dados de ImportaÃ§Ã£o de Extrato CSV

| Campo           | Tipo      | ObrigatÃ³rio | DescriÃ§Ã£o                                                  | RestriÃ§Ãµes                                                            |
|-----------------|-----------|-------------|------------------------------------------------------------|-----------------------------------------------------------------------|
| `accountId`     | `string`  | âœ… Sim       | ID Ãºnico da conta bancÃ¡ria na plataforma.                  | Deve ser um ID de conta vÃ¡lido e existente do usuÃ¡rio.                |
| `csvContent`    | `string`  | âœ… Sim       | ConteÃºdo do arquivo CSV em formato de texto.               | Deve ser um string CSV vÃ¡lido.                                        |
| `columnMapping` | `object`  | âœ… Sim       | Mapeamento das colunas do CSV para os campos da transaÃ§Ã£o. | Ex: `{"date": "Data", "description": "HistÃ³rico", "amount": "Valor"}` |
| `hasHeader`     | `boolean` | âœ… Sim       | Indica se o CSV tem linha de cabeÃ§alho.                    | PadrÃ£o: `true`.                                                       |

## ðŸ“‹ Dados de SaÃ­da (Status da ImportaÃ§Ã£o)

| Campo                        | Tipo     | DescriÃ§Ã£o                                                | RestriÃ§Ãµes                                                                                   |
|------------------------------|----------|----------------------------------------------------------|----------------------------------------------------------------------------------------------|
| `status`                     | `string` | Status da importaÃ§Ã£o.                                    | Valores: `SUCCESS`, `INVALID_CSV`, `ACCOUNT_NOT_FOUND`, `MAPPING_ERROR`, `PROCESSING_ERROR`. |
| `importedTransactionsCount`  | `number` | NÃºmero de transaÃ§Ãµes importadas com sucesso.             | N/A                                                                                          |
| `duplicateTransactionsCount` | `number` | NÃºmero de transaÃ§Ãµes duplicadas encontradas e ignoradas. | N/A                                                                                          |
| `message`                    | `string` | Mensagem descritiva do resultado da importaÃ§Ã£o.          | N/A                                                                                          |
| `errors`                     | `array`  | Lista de erros encontrados durante a importaÃ§Ã£o.         | N/A                                                                                          |

## ðŸ”„ Fluxo Principal

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant A as Aplicativo
    participant S as Sistema
    U ->> A: 1. Seleciona opÃ§Ã£o de importar extrato CSV para uma conta
    A ->> U: 2. Solicita upload do arquivo CSV e mapeamento de colunas
    U ->> A: 3. Faz upload do arquivo CSV e define mapeamento
    A ->> S: 4. Envia o conteÃºdo do arquivo CSV e mapeamento para processamento (POST /api/accounts/{accountId}/import/csv)
    S ->> S: 5. Valida CSV, parseia linhas e aplica mapeamento
    S ->> S: 6. Verifica duplicidade e registra novas transaÃ§Ãµes
    S ->> A: 7. Retorna o status da importaÃ§Ã£o com contagem de transaÃ§Ãµes
    A ->> U: 8. Exibe resumo da importaÃ§Ã£o (sucesso, duplicadas, erros)
```

1. O UsuÃ¡rio acessa a seÃ§Ã£o de contas bancÃ¡rias e seleciona a opÃ§Ã£o de importar extrato CSV para uma conta especÃ­fica (
   `accountId`).
2. O aplicativo solicita que o usuÃ¡rio selecione e faÃ§a o upload de um arquivo CSV de seu dispositivo e, opcionalmente,
   oferece um assistente para mapear as colunas do CSV para os campos da transaÃ§Ã£o (ex: "Data", "DescriÃ§Ã£o", "Valor").
3. O UsuÃ¡rio seleciona o arquivo CSV, insere ou confirma o `columnMapping` e indica se o arquivo tem `hasHeader`.
4. O aplicativo lÃª o conteÃºdo do arquivo CSV e o envia como uma string (ou um buffer), juntamente com o `columnMapping`
   e `hasHeader`, para o endpoint `POST /api/accounts/{accountId}/import/csv`.
5. O sistema backend recebe o conteÃºdo do CSV, o valida (estrutura do arquivo, delimitador), parseia cada linha de
   acordo com o `columnMapping` e cria objetos de transaÃ§Ã£o. Em seguida, compara com as transaÃ§Ãµes existentes na
   `accountId` para evitar duplicidade. TransaÃ§Ãµes jÃ¡ existentes sÃ£o ignoradas.
6. O sistema registra as novas transaÃ§Ãµes no banco de dados, associando-as Ã  `accountId` do usuÃ¡rio, e atualiza o saldo
   da conta com base nas transaÃ§Ãµes importadas.
7. O sistema retorna uma resposta HTTP 200 OK contendo um resumo da importaÃ§Ã£o, incluindo o `status`,
   `importedTransactionsCount`, `duplicateTransactionsCount` e `message`.
8. O aplicativo exibe ao usuÃ¡rio um relatÃ³rio da importaÃ§Ã£o, informando quantas transaÃ§Ãµes foram importadas, quantas
   foram duplicadas e quaisquer erros que ocorreram.

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - SugestÃ£o de Mapeamento de Colunas

1. Antes do upload, o aplicativo pode ler as primeiras linhas do CSV e sugerir um `columnMapping` com base em nomes de
   colunas comuns (e.g., "Data", "DescriÃ§Ã£o", "Valor").
2. O usuÃ¡rio pode aceitar a sugestÃ£o ou ajustÃ¡-la manualmente.

### âš ï¸ FA02 - Tratamento de Formatos de Data/NÃºmero

1. O sistema backend pode ter regras para inferir e converter diferentes formatos de data (DD/MM/YYYY, MM-DD-YYYY) e
   nÃºmeros (com vÃ­rgula como separador decimal).
2. O usuÃ¡rio pode ser capaz de selecionar o formato esperado durante o mapeamento.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Conta BancÃ¡ria NÃ£o Encontrada ou NÃ£o Pertencente ao UsuÃ¡rio

1. O `accountId` especificado na requisiÃ§Ã£o nÃ£o Ã© encontrado ou nÃ£o pertence ao usuÃ¡rio autenticado.
2. O sistema retorna uma resposta HTTP 404 Not Found.

### âš ï¸ FE02 - Arquivo CSV InvÃ¡lido/Mal Formado

1. O conteÃºdo do `csvContent` nÃ£o Ã© um CSV vÃ¡lido (erros de sintaxe, linhas incompletas).
2. O sistema retorna um `status: INVALID_CSV` e uma mensagem de erro.

### âš ï¸ FE03 - Erro de Mapeamento de Colunas

1. O `columnMapping` fornecido Ã© invÃ¡lido (e.g., nome de coluna no CSV nÃ£o existe no mapeamento, campos obrigatÃ³rios nÃ£o
   mapeados).
2. O sistema retorna um `status: MAPPING_ERROR` e uma mensagem de erro detalhando o problema.

### âš ï¸ FE04 - Erro no Processamento das TransaÃ§Ãµes

1. Durante o parsing das linhas ou salvamento das transaÃ§Ãµes, ocorre um erro interno (e.g., erro de banco de dados,
   inconsistÃªncia de dados).
2. O sistema retorna um `status: PROCESSING_ERROR` e uma lista de `errors` detalhando as falhas especÃ­ficas.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para Importar um Extrato CSV

```http
POST /api/accounts/acc_xyz123/import/csv HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "accountId": "acc_xyz123",
  "csvContent": "Data,DescriÃ§Ã£o,Valor,Tipo\n2024-07-15,Compra Supermercado,-150.25,DÃ©bito\n2024-07-16,SalÃ¡rio,+3000.00,CrÃ©dito\n2024-07-17,Cinema,-45.00,DÃ©bito",
  "columnMapping": {
    "date": "Data",
    "description": "DescriÃ§Ã£o",
    "amount": "Valor",
    "type": "Tipo"
  },
  "hasHeader": true
}
```

### Exemplo de Resposta de Sucesso

```json
{
  "status": "SUCCESS",
  "importedTransactionsCount": 3,
  "duplicateTransactionsCount": 0,
  "message": "Extrato CSV importado com sucesso. 3 novas transaÃ§Ãµes adicionadas."
}
```

### Exemplo de Resposta com Erro (Mapeamento InvÃ¡lido)

```json
{
  "status": "MAPPING_ERROR",
  "importedTransactionsCount": 0,
  "duplicateTransactionsCount": 0,
  "message": "Erro no mapeamento: coluna 'Valor' nÃ£o encontrada no CSV.",
  "errors": ["Coluna 'Valor' nÃ£o existe no arquivo CSV."]
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 