# RF009.2 ðŸ”„ CriaÃ§Ã£o e gestÃ£o de transaÃ§Ãµes parceladas

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a criaÃ§Ã£o e gestÃ£o de transaÃ§Ãµes divididas em mÃºltiplas parcelas, com controle individual do
status de cada parcela, ideal para compras parceladas no cartÃ£o de crÃ©dito ou outros pagamentos divididos.

## ðŸ‘¥ Atores

- ðŸ‘¤ UsuÃ¡rio Autenticado

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar logado no sistema.
- O usuÃ¡rio deve ter categorias e formas de pagamento configuradas.

## ðŸ”Œ Endpoints

- `POST /api/installment-transactions`
- `GET /api/installment-transactions`
- `GET /api/installment-transactions/{installmentTransactionId}`
- `PUT /api/installment-transactions/{installmentTransactionId}`
- `DELETE /api/installment-transactions/{installmentTransactionId}`
- `PUT /api/installment-transactions/installments/{installmentId}/status` (para atualizar status de parcela)

## ðŸ“‹ Dados da TransaÃ§Ã£o Parcelada

| Campo                    | Tipo     | ObrigatÃ³rio | DescriÃ§Ã£o                                   | RestriÃ§Ãµes                                |
|--------------------------|----------|-------------|---------------------------------------------|-------------------------------------------|
| `type`                   | `string` | âœ… Sim       | Tipo de transaÃ§Ã£o (despesa)                 | `expense`                                 |
| `total_amount`           | `number` | âœ… Sim       | Valor total da transaÃ§Ã£o                    | Valor positivo, com duas casas decimais   |
| `description`            | `string` | âœ… Sim       | DescriÃ§Ã£o da transaÃ§Ã£o                      | MÃ­nimo de 3 caracteres                    |
| `category_id`            | `string` | âœ… Sim       | ID da categoria da transaÃ§Ã£o                | UUID vÃ¡lido, categoria existente          |
| `payment_method_id`      | `string` | âœ… Sim       | ID da forma de pagamento utilizada          | UUID vÃ¡lido, forma de pagamento existente |
| `account_id`             | `string` | âœ… Sim       | ID da conta/carteira envolvida na transaÃ§Ã£o | UUID vÃ¡lido, conta/carteira existente     |
| `number_of_installments` | `number` | âœ… Sim       | NÃºmero total de parcelas                    | Inteiro positivo, mÃ­nimo 2                |
| `first_installment_date` | `string` | âœ… Sim       | Data da primeira parcela                    | Formato YYYY-MM-DD, nÃ£o futura            |

## ðŸ“‹ Dados da Parcela Individual

| Campo           | Tipo     | ObrigatÃ³rio | DescriÃ§Ã£o                      | RestriÃ§Ãµes                   |
|-----------------|----------|-------------|--------------------------------|------------------------------|
| `installmentId` | `string` | âœ… Sim       | ID Ãºnico da parcela            | UUID vÃ¡lido                  |
| `status`        | `string` | âœ… Sim       | Status de pagamento da parcela | `paid`, `pending`, `overdue` |

## ðŸ”„ Fluxo Principal - CriaÃ§Ã£o de TransaÃ§Ã£o Parcelada

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant S as Sistema
    participant BD as Banco de Dados
    U->>S: Acessa a seÃ§Ã£o de transaÃ§Ãµes parceladas
    S->>U: Exibe formulÃ¡rio para nova transaÃ§Ã£o parcelada
    U->>S: Preenche dados (valor total, descriÃ§Ã£o, categoria, forma de pagamento, conta, nÂº de parcelas, data da 1Âª parcela)
    S->>S: Valida os dados da transaÃ§Ã£o
    S->>BD: Salva a transaÃ§Ã£o parcelada (com todas as parcelas como pendentes)
    BD->>S: Confirma o salvamento
    S->>U: Exibe mensagem de sucesso e a transaÃ§Ã£o parcelada na lista
```

1. O usuÃ¡rio autenticado acessa a seÃ§Ã£o de gerenciamento de transaÃ§Ãµes parceladas.
2. O sistema exibe um formulÃ¡rio para a criaÃ§Ã£o de uma nova transaÃ§Ã£o parcelada.
3. O usuÃ¡rio preenche os dados, incluindo: valor total, descriÃ§Ã£o, categoria, forma de pagamento, conta envolvida,
   nÃºmero de parcelas e a data da primeira parcela.
4. O sistema valida os dados informados, calculando o valor de cada parcela e gerando as parcelas individuais com
   status "pendente".
5. O sistema salva a transaÃ§Ã£o parcelada e todas as suas parcelas no banco de dados.
6. O sistema exibe uma mensagem de confirmaÃ§Ã£o de sucesso e a nova transaÃ§Ã£o parcelada Ã© adicionada Ã  lista do usuÃ¡rio,
   com o detalhamento das parcelas.

## ðŸ”„ Fluxo Principal - GestÃ£o de TransaÃ§Ãµes Parceladas

```mermaid
sequenceDiagram
    actor U as UsuÃ¡rio
    participant S as Sistema
    participant BD as Banco de Dados
    U->>S: Acessa a seÃ§Ã£o de transaÃ§Ãµes parceladas
    S->>BD: Solicita lista de transaÃ§Ãµes parceladas do usuÃ¡rio
    BD->>S: Retorna lista de transaÃ§Ãµes
    S->>U: Exibe a lista de transaÃ§Ãµes parceladas e suas parcelas
    U->>S: Seleciona transaÃ§Ã£o ou parcela para visualizar/editar/excluir/atualizar status
    alt Visualizar TransaÃ§Ã£o Parcelada
        S->>BD: Solicita detalhes da transaÃ§Ã£o e parcelas
        BD->>S: Retorna detalhes
        S->>U: Exibe detalhes da transaÃ§Ã£o e suas parcelas
    else Atualizar Status de Parcela
        U->>S: Seleciona parcela e informa novo status (paga)
        S->>S: Valida status
        S->>BD: Atualiza status da parcela e saldo da conta
        BD->>S: Confirma atualizaÃ§Ã£o
        S->>U: Exibe sucesso e parcela atualizada
    else Editar TransaÃ§Ã£o Parcelada (apenas campos gerais)
        S->>U: Exibe formulÃ¡rio de ediÃ§Ã£o
        U->>S: Altera descriÃ§Ã£o/categoria e envia
        S->>S: Valida dados
        S->>BD: Atualiza transaÃ§Ã£o parcelada
        BD->>S: Confirma atualizaÃ§Ã£o
        S->>U: Exibe sucesso e transaÃ§Ã£o atualizada
    else Excluir TransaÃ§Ã£o Parcelada
        S->>U: Solicita confirmaÃ§Ã£o
        U->>S: Confirma exclusÃ£o
        S->>BD: Remove transaÃ§Ã£o e todas as parcelas
        BD->>S: Confirma remoÃ§Ã£o
        S->>U: Exibe sucesso e remove transaÃ§Ã£o da lista
    end
```

1. O usuÃ¡rio autenticado acessa a seÃ§Ã£o de gerenciamento de transaÃ§Ãµes parceladas.
2. O sistema exibe uma lista de todas as transaÃ§Ãµes parceladas cadastradas, com o status de cada parcela.
3. O usuÃ¡rio seleciona uma opÃ§Ã£o:
   a. **Visualizar Detalhes:** O sistema exibe os detalhes completos da transaÃ§Ã£o parcelada e de todas as suas
   parcelas (valor, data de vencimento, status).
   b. **Atualizar Status da Parcela:** O usuÃ¡rio seleciona uma parcela e marca-a como paga, pendente ou vencida. O
   sistema atualiza o status no banco de dados e, se paga, registra a saÃ­da de valor da conta envolvida.
   c. **Editar TransaÃ§Ã£o Parcelada:** O usuÃ¡rio pode editar informaÃ§Ãµes gerais da transaÃ§Ã£o parcelada (ex: descriÃ§Ã£o,
   categoria), mas nÃ£o o nÃºmero de parcelas ou valor total apÃ³s a criaÃ§Ã£o. O sistema valida e atualiza os dados.
   d. **Excluir TransaÃ§Ã£o Parcelada:** O sistema solicita uma confirmaÃ§Ã£o e, apÃ³s a confirmaÃ§Ã£o, remove a transaÃ§Ã£o
   parcelada e todas as suas parcelas do banco de dados, revertendo quaisquer impactos em saldos de contas se
   necessÃ¡rio.
4. O sistema exibe uma mensagem de sucesso apÃ³s cada operaÃ§Ã£o e atualiza a lista.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Dados invÃ¡lidos

1. Durante a criaÃ§Ã£o ou ediÃ§Ã£o, se os dados informados forem invÃ¡lidos (ex: nÃºmero de parcelas menor que 2, valor total
   negativo, `category_id` inexistente), o sistema exibe uma mensagem de erro especÃ­fica.
2. O sistema retorna ao formulÃ¡rio para que o usuÃ¡rio corrija os dados.

### âš ï¸ FE02 - TransaÃ§Ã£o/Parcela nÃ£o encontrada

1. Ao tentar visualizar, editar, excluir ou atualizar o status de uma transaÃ§Ã£o ou parcela com um ID invÃ¡lido, o sistema
   exibe uma mensagem de erro indicando que o item nÃ£o foi encontrado.

### âš ï¸ FE03 - Erro ao salvar/atualizar/excluir

1. Se ocorrer um erro interno no sistema durante as operaÃ§Ãµes, o sistema exibe uma mensagem de erro genÃ©rica e sugere
   que o usuÃ¡rio tente novamente mais tarde.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP - Criar TransaÃ§Ã£o Parcelada

```http
POST /api/installment-transactions HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json
Authorization: Bearer [TOKEN_DE_AUTENTICACAO]

{
  "type": "expense",
  "total_amount": 600.00,
  "description": "Compra de eletrÃ´nicos",
  "category_id": "uuid-da-categoria-eletronicos",
  "payment_method_id": "uuid-da-forma-pagamento-cartao-credito",
  "account_id": "uuid-da-conta-cartao-credito",
  "number_of_installments": 10,
  "first_installment_date": "2023-11-05"
}
```

### RequisiÃ§Ã£o HTTP - Listar TransaÃ§Ãµes Parceladas

```http
GET /api/installment-transactions HTTP/1.1
Host: api.metakyasshu.com
Authorization: Bearer [TOKEN_DE_AUTENTICACAO]
```

### RequisiÃ§Ã£o HTTP - Atualizar Status de Parcela

```http
PUT /api/installment-transactions/installments/a1b2c3d4e5f6-1234-5678-90ab-cdef12345678/status HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json
Authorization: Bearer [TOKEN_DE_AUTENTICACAO]

{
  "status": "paid"
}
```

### RequisiÃ§Ã£o HTTP - Excluir TransaÃ§Ã£o Parcelada

```http
DELETE /api/installment-transactions/a1b2c3d4e5f6-1234-5678-90ab-cdef12345678 HTTP/1.1
Host: api.metakyasshu.com
Authorization: Bearer [TOKEN_DE_AUTENTICACAO]
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 