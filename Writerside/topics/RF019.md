# RF019 ðŸ’¸ DivisÃ£o de gastos entre membros do grupo

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a divisÃ£o de gastos entre membros do grupo, com cÃ¡lculo automÃ¡tico da parte de cada um e
opÃ§Ãµes de personalizaÃ§Ã£o. O objetivo Ã© simplificar a gestÃ£o financeira compartilhada, permitindo que os usuÃ¡rios
registrem um gasto e o dividam de diversas formas entre os participantes, facilitando o acerto de contas.

## ðŸ‘¥ Atores

- ðŸ‘¤ **UsuÃ¡rio do Grupo**: O usuÃ¡rio que registra o gasto e inicia a divisÃ£o.
- ðŸ‘¥ **Membros do Grupo**: Os usuÃ¡rios que participarÃ£o da divisÃ£o do gasto.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- O gasto a ser dividido deve ter sido registrado e pertencer ao grupo.
- O grupo financeiro deve existir e ter membros vÃ¡lidos.

## ðŸ”Œ Endpoints

- `POST /api/groups/{groupId}/transactions/{transactionId}/split`

## ðŸ“‹ Dados de DivisÃ£o de Gasto

| Campo                       | Tipo     | ObrigatÃ³rio | DescriÃ§Ã£o                                                | RestriÃ§Ãµes                                                                                 |
|-----------------------------|----------|-------------|----------------------------------------------------------|--------------------------------------------------------------------------------------------|
| `groupId`                   | `string` | âœ… Sim       | ID Ãºnico do grupo financeiro.                            | Deve ser um ID de grupo vÃ¡lido e existente.                                                |
| `transactionId`             | `string` | âœ… Sim       | ID Ãºnico da transaÃ§Ã£o a ser dividida.                    | Deve ser um ID de transaÃ§Ã£o vÃ¡lido e existente do grupo especificado.                      |
| `splitType`                 | `string` | âœ… Sim       | Tipo de divisÃ£o do gasto.                                | Valores permitidos: `EQUAL`, `PERCENTAGE`, `CUSTOM`.                                       |
| `participants`              | `array`  | âœ… Sim       | Lista de participantes e suas respectivas contribuiÃ§Ãµes. | Array de objetos contendo `userId` e, dependendo do `splitType`, `amount` ou `percentage`. |
| `participants[].userId`     | `string` | âœ… Sim       | ID Ãºnico do membro do grupo participante da divisÃ£o.     | Deve ser um ID de usuÃ¡rio vÃ¡lido e pertencente ao grupo.                                   |
| `participants[].amount`     | `number` | Condicional | Valor exato da participaÃ§Ã£o do membro na divisÃ£o.        | ObrigatÃ³rio se `splitType` for `CUSTOM`. Deve ser um nÃºmero positivo.                      |
| `participants[].percentage` | `number` | Condicional | Porcentagem da participaÃ§Ã£o do membro na divisÃ£o.        | ObrigatÃ³rio se `splitType` for `PERCENTAGE`. Deve ser um nÃºmero entre 0 e 100.             |

## ðŸ”„ Fluxo Principal

```mermaid
sequenceDiagram
    actor A as UsuÃ¡rio do Grupo
    participant S as Sistema
    A ->> S: 1. Registra um gasto e solicita a divisÃ£o (POST /api/groups/{groupId}/transactions/{transactionId}/split)
    S ->> S: 2. Valida o gasto, o grupo e os participantes
    S ->> S: 3. Calcula a divisÃ£o do gasto com base no `splitType` e `participants`
    S ->> S: 4. Registra as dÃ­vidas/crÃ©ditos individuais no banco de dados
    S ->> A: 5. Retorna confirmaÃ§Ã£o de sucesso com detalhes da divisÃ£o (HTTP 200 OK)
```

1. O UsuÃ¡rio do Grupo envia uma requisiÃ§Ã£o POST para `/api/groups/{groupId}/transactions/{transactionId}/split` com os
   detalhes da divisÃ£o (tipo e participantes).
2. O sistema valida se a `transactionId` pertence ao `groupId` e se todos os `userId` em `participants` sÃ£o membros
   vÃ¡lidos do grupo.
3. O sistema calcula a parte de cada participante com base no `splitType` (e.g., divisÃ£o igual, por porcentagem, valores
   customizados).
4. O sistema registra as dÃ­vidas e crÃ©ditos individuais resultantes da divisÃ£o no banco de dados, vinculando-os aos
   membros do grupo.
5. O sistema retorna uma resposta HTTP 200 OK com uma mensagem de sucesso e os detalhes da divisÃ£o efetuada (e.g.,
   quanto cada um deve/recebeu).

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - DivisÃ£o por Porcentagem

1. O `splitType` Ã© definido como `PERCENTAGE` e cada participante tem um `percentage` especificado.
2. O sistema calcula a contribuiÃ§Ã£o de cada um com base na porcentagem fornecida sobre o valor total do gasto.

### âš ï¸ FA02 - DivisÃ£o Customizada

1. O `splitType` Ã© definido como `CUSTOM` e cada participante tem um `amount` especificado.
2. O sistema verifica se a soma dos `amount`s corresponde ao valor total do gasto e registra as contribuiÃ§Ãµes exatas.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Gasto NÃ£o Encontrado ou NÃ£o Pertencente ao Grupo

1. O `transactionId` especificado nÃ£o Ã© encontrado ou nÃ£o pertence ao `groupId`.
2. O sistema retorna uma resposta HTTP 404 Not Found.

### âš ï¸ FE02 - Tipo de DivisÃ£o InvÃ¡lido

1. O `splitType` fornecido nÃ£o Ã© `EQUAL`, `PERCENTAGE` ou `CUSTOM`.
2. O sistema retorna uma resposta HTTP 400 Bad Request.

### âš ï¸ FE03 - Dados de Participantes InvÃ¡lidos

1. O array `participants` estÃ¡ vazio, contÃ©m IDs de usuÃ¡rios invÃ¡lidos, ou a soma das porcentagens/valores nÃ£o
   corresponde ao total do gasto (para `PERCENTAGE` ou `CUSTOM`).
2. O sistema retorna uma resposta HTTP 400 Bad Request.

### âš ï¸ FE04 - Membros NÃ£o Pertencentes ao Grupo

1. Um ou mais `userId` em `participants` nÃ£o sÃ£o membros ativos do `groupId` especificado.
2. O sistema retorna uma resposta HTTP 400 Bad Request.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para DivisÃ£o Igual (entre 3 pessoas para um gasto de 30)

```http
POST /api/groups/grp_abc456/transactions/trn_xyz789/split HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "splitType": "EQUAL",
  "participants": [
    { "userId": "usr_111" },
    { "userId": "usr_222" },
    { "userId": "usr_333" }
  ]
}
```

### RequisiÃ§Ã£o HTTP para DivisÃ£o por Porcentagem (para um gasto de 100)

```http
POST /api/groups/grp_abc456/transactions/trn_xyz789/split HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "splitType": "PERCENTAGE",
  "participants": [
    { "userId": "usr_111", "percentage": 50 },
    { "userId": "usr_222", "percentage": 30 },
    { "userId": "usr_333", "percentage": 20 }
  ]
}
```

### RequisiÃ§Ã£o HTTP para DivisÃ£o Customizada (para um gasto de 100)

```http
POST /api/groups/grp_abc456/transactions/trn_xyz789/split HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "splitType": "CUSTOM",
  "participants": [
    { "userId": "usr_111", "amount": 40 },
    { "userId": "usr_222", "amount": 30 },
    { "userId": "usr_333", "amount": 30 }
  ]
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 