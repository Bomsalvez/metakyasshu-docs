# RF021 ðŸ§¾ ConfirmaÃ§Ã£o individual de pagamento em despesas compartilhadas

## ðŸ“ DescriÃ§Ã£o

Esta funcionalidade permite a confirmaÃ§Ã£o individual de pagamento da parte de cada membro em despesas compartilhadas,
com a opÃ§Ã£o de reflexÃ£o automÃ¡tica ao membro principal. O objetivo Ã© facilitar o acompanhamento e a liquidaÃ§Ã£o de
dÃ­vidas dentro de um grupo, proporcionando transparÃªncia sobre quem jÃ¡ pagou sua parte de um gasto comum.

## ðŸ‘¥ Atores

- ðŸ‘¤ **Membro Pagador**: O usuÃ¡rio que pagou sua parte em uma despesa compartilhada.
- ðŸ‘¥ **Membro Principal/Credor**: O usuÃ¡rio que iniciou a despesa ou Ã© o responsÃ¡vel por receber os pagamentos.

## âš ï¸ PrÃ©-condiÃ§Ãµes

- O usuÃ¡rio deve estar autenticado no sistema.
- A despesa compartilhada deve existir e o Membro Pagador deve ter uma parte atribuÃ­da a ela.
- O status da parte do Membro Pagador na despesa deve ser "pendente".

## ðŸ”Œ Endpoints

- `POST /api/shared-expenses/{expenseId}/payments/{userId}/confirm`

## ðŸ“‹ Dados de ConfirmaÃ§Ã£o de Pagamento

| Campo         | Tipo                | ObrigatÃ³rio | DescriÃ§Ã£o                                                              | RestriÃ§Ãµes                                                                 |
|---------------|---------------------|-------------|------------------------------------------------------------------------|----------------------------------------------------------------------------|
| `expenseId`   | `string`            | âœ… Sim       | ID Ãºnico da despesa compartilhada.                                     | Deve ser um ID de despesa vÃ¡lido e existente.                              |
| `userId`      | `string`            | âœ… Sim       | ID Ãºnico do usuÃ¡rio (Membro Pagador) que estÃ¡ confirmando o pagamento. | Deve ser um ID de usuÃ¡rio vÃ¡lido e participante da despesa.                |
| `amountPaid`  | `number`            | âŒ NÃ£o       | Opcional. Valor exato pago pelo membro, se for um pagamento parcial.   | Deve ser um nÃºmero positivo. Se omitido, assume-se o valor total pendente. |
| `paymentDate` | `string` (ISO 8601) | âœ… Sim       | Data em que o pagamento foi realizado.                                 | Formato `YYYY-MM-DD`.                                                      |
| `proofUrl`    | `string`            | âŒ NÃ£o       | URL de um comprovante de pagamento (ex: imagem).                       | Deve ser uma URL vÃ¡lida.                                                   |

## ðŸ”„ Fluxo Principal

```mermaid
sequenceDiagram
    actor A as Membro Pagador
    participant S as Sistema
    A ->> S: 1. Confirma o pagamento de sua parte em uma despesa compartilhada (POST /api/shared-expenses/{expenseId}/payments/{userId}/confirm)
    S ->> S: 2. Valida o membro, a despesa e o valor pago
    S ->> S: 3. Atualiza o status de pagamento do membro para "pago" (ou atualiza o saldo pendente)
    S ->> S: 4. Notifica o Membro Principal/Credor
    S ->> A: 5. Retorna confirmaÃ§Ã£o de sucesso (HTTP 200 OK)
```

1. O Membro Pagador envia uma requisiÃ§Ã£o POST para `/api/shared-expenses/{expenseId}/payments/{userId}/confirm` com os
   detalhes do pagamento.
2. O sistema valida se o `userId` corresponde a um participante da `expenseId` e se o `amountPaid` Ã© vÃ¡lido (se
   fornecido).
3. O sistema atualiza o status de pagamento da parte do `userId` na despesa compartilhada para "Pago" se o `amountPaid`
   for igual ao valor total pendente, ou ajusta o saldo pendente se for um pagamento parcial.
4. O sistema pode enviar uma notificaÃ§Ã£o ao Membro Principal/Credor da despesa informando sobre o pagamento.
5. O sistema retorna uma resposta HTTP 200 OK com uma mensagem de sucesso e o status atualizado da despesa.

## ðŸ”€ Fluxos Alternativos

### âš ï¸ FA01 - Pagamento Parcial

1. O Membro Pagador informa um `amountPaid` menor que o valor total de sua parte.
2. O sistema atualiza o saldo pendente daquele membro para a despesa, mas mantÃ©m o status geral da despesa como "
   pendente" atÃ© que todo o valor seja quitado.

### âš ï¸ FA02 - ConfirmaÃ§Ã£o com Comprovante

1. O Membro Pagador inclui uma `proofUrl` na requisiÃ§Ã£o.
2. O sistema armazena a URL do comprovante e a disponibiliza para visualizaÃ§Ã£o pelo Membro Principal/Credor.

## ðŸš« Fluxos de ExceÃ§Ã£o

### âš ï¸ FE01 - Despesa NÃ£o Encontrada ou NÃ£o Compartilhada com o UsuÃ¡rio

1. A `expenseId` especificada nÃ£o Ã© encontrada ou o `userId` nÃ£o Ã© um participante da despesa.
2. O sistema retorna uma resposta HTTP 404 Not Found.

### âš ï¸ FE02 - Pagamento JÃ¡ Confirmado

1. O `userId` tenta confirmar o pagamento de uma despesa ou parte de uma despesa que jÃ¡ foi totalmente paga.
2. O sistema retorna uma resposta HTTP 409 Conflict.

### âš ï¸ FE03 - Valor Pago InvÃ¡lido

1. O `amountPaid` fornecido Ã© negativo ou maior que o valor total pendente para o `userId` na despesa.
2. O sistema retorna uma resposta HTTP 400 Bad Request.

## ðŸ§ª Exemplos de Uso

### RequisiÃ§Ã£o HTTP para Confirmar Pagamento Total

```http
POST /api/shared-expenses/exp_789ghi/payments/usr_jkl012/confirm HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "paymentDate": "2024-07-20"
}
```

### RequisiÃ§Ã£o HTTP para Confirmar Pagamento Parcial com Comprovante

```http
POST /api/shared-expenses/exp_789ghi/payments/usr_mno345/confirm HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "amountPaid": 15.50,
  "paymentDate": "2024-07-19",
  "proofUrl": "https://example.com/receipts/exp_789ghi_usr_mno345.png"
}
```

---

> ---------------------------------------------------------------------------
> #### ðŸ’° METAKYASSHU ðŸ’°
> ***Transformando finanÃ§as em conquistas compartilhadas***
> --------------------------------------------------------------------------- 