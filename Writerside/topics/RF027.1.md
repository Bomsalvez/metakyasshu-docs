# RF027.1 üì• Importa√ß√£o de extratos OFX

## üìù Descri√ß√£o

Esta funcionalidade permite a importa√ß√£o de extratos banc√°rios no formato OFX (Open Financial Exchange). Os usu√°rios
podem carregar seus arquivos OFX para sincronizar transa√ß√µes e saldos de suas contas banc√°rias manualmente, o que √© √∫til
para bancos que n√£o suportam Open Banking ou para usu√°rios que preferem um controle manual sobre a importa√ß√£o de dados.

## üë• Atores

- üë§ **Usu√°rio**: O indiv√≠duo que possui o extrato OFX e deseja import√°-lo para a plataforma.

## ‚ö†Ô∏è Pr√©-condi√ß√µes

- O usu√°rio deve estar autenticado no sistema.
- O usu√°rio deve ter um arquivo OFX v√°lido de um extrato banc√°rio.
- O usu√°rio deve ter uma conta banc√°ria correspondente registrada na plataforma para associar o extrato.

## üîå Endpoints

- `POST /api/accounts/{accountId}/import/ofx` (Importar extrato OFX para uma conta)

## üìã Dados de Importa√ß√£o de Extrato OFX

| Campo        | Tipo     | Obrigat√≥rio | Descri√ß√£o                                    | Restri√ß√µes                                             |
|--------------|----------|-------------|----------------------------------------------|--------------------------------------------------------|
| `accountId`  | `string` | ‚úÖ Sim       | ID √∫nico da conta banc√°ria na plataforma.    | Deve ser um ID de conta v√°lido e existente do usu√°rio. |
| `ofxContent` | `string` | ‚úÖ Sim       | Conte√∫do do arquivo OFX em formato de texto. | Deve ser um string XML/SGML OFX v√°lido.                |

## üìã Dados de Sa√≠da (Status da Importa√ß√£o)

| Campo                        | Tipo     | Descri√ß√£o                                                | Restri√ß√µes                                                                                            |
|------------------------------|----------|----------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| `status`                     | `string` | Status da importa√ß√£o.                                    | Valores: `SUCCESS`, `INVALID_OFX`, `ACCOUNT_NOT_FOUND`, `DUPLICATE_TRANSACTIONS`, `PROCESSING_ERROR`. |
| `importedTransactionsCount`  | `number` | N√∫mero de transa√ß√µes importadas com sucesso.             | N/A                                                                                                   |
| `duplicateTransactionsCount` | `number` | N√∫mero de transa√ß√µes duplicadas encontradas e ignoradas. | N/A                                                                                                   |
| `message`                    | `string` | Mensagem descritiva do resultado da importa√ß√£o.          | N/A                                                                                                   |
| `errors`                     | `array`  | Lista de erros encontrados durante a importa√ß√£o.         | N/A                                                                                                   |

## üîÑ Fluxo Principal

```mermaid
sequenceDiagram
    actor U as Usu√°rio
    participant A as Aplicativo
    participant S as Sistema
    U ->> A: 1. Seleciona op√ß√£o de importar extrato OFX para uma conta
    A ->> U: 2. Solicita upload do arquivo OFX
    U ->> A: 3. Faz upload do arquivo OFX
    A ->> S: 4. Envia o conte√∫do do arquivo OFX para processamento (POST /api/accounts/{accountId}/import/ofx)
    S ->> S: 5. Valida o OFX, parseia transa√ß√µes e verifica duplicidade
    S ->> S: 6. Registra novas transa√ß√µes e atualiza o saldo da conta
    S ->> A: 7. Retorna o status da importa√ß√£o com contagem de transa√ß√µes
    A ->> U: 8. Exibe resumo da importa√ß√£o (sucesso, duplicadas, erros)
```

1. O Usu√°rio acessa a se√ß√£o de contas banc√°rias e seleciona a op√ß√£o de importar extrato OFX para uma conta espec√≠fica (
   `accountId`).
2. O aplicativo solicita que o usu√°rio selecione e fa√ßa o upload de um arquivo OFX de seu dispositivo.
3. O Usu√°rio seleciona e faz o upload do arquivo OFX.
4. O aplicativo l√™ o conte√∫do do arquivo OFX e o envia como uma string (ou um buffer) para o endpoint
   `POST /api/accounts/{accountId}/import/ofx`.
5. O sistema backend recebe o conte√∫do do OFX, o valida (estrutura do arquivo), parseia as transa√ß√µes e as compara com
   as transa√ß√µes existentes na `accountId` para evitar duplicidade. Transa√ß√µes j√° existentes s√£o ignoradas.
6. O sistema registra as novas transa√ß√µes no banco de dados, associando-as √† `accountId` do usu√°rio, e atualiza o saldo
   da conta com base nas transa√ß√µes importadas.
7. O sistema retorna uma resposta HTTP 200 OK contendo um resumo da importa√ß√£o, incluindo o `status`,
   `importedTransactionsCount`, `duplicateTransactionsCount` e `message`.
8. O aplicativo exibe ao usu√°rio um relat√≥rio da importa√ß√£o, informando quantas transa√ß√µes foram importadas, quantas
   foram duplicadas e quaisquer erros que ocorreram.

## üîÄ Fluxos Alternativos

### ‚ö†Ô∏è FA01 - Categoriza√ß√£o Autom√°tica P√≥s-Importa√ß√£o

1. Ap√≥s a importa√ß√£o, o sistema pode tentar categorizar automaticamente as novas transa√ß√µes com base em regras
   predefinidas ou aprendizado de m√°quina.
2. As transa√ß√µes s√£o importadas com uma categoria sugerida, que o usu√°rio pode revisar e ajustar.

### ‚ö†Ô∏è FA02 - Processamento em Lotes para Grandes Arquivos

1. Para arquivos OFX muito grandes, o processamento pode ser feito em segundo plano para evitar timeouts.
2. O usu√°rio √© notificado quando a importa√ß√£o estiver conclu√≠da e os dados estiverem dispon√≠veis.

## üö´ Fluxos de Exce√ß√£o

### ‚ö†Ô∏è FE01 - Conta Banc√°ria N√£o Encontrada ou N√£o Pertencente ao Usu√°rio

1. O `accountId` especificado na requisi√ß√£o n√£o √© encontrado ou n√£o pertence ao usu√°rio autenticado.
2. O sistema retorna uma resposta HTTP 404 Not Found.

### ‚ö†Ô∏è FE02 - Arquivo OFX Inv√°lido/Corrompido

1. O conte√∫do do `ofxContent` n√£o √© um OFX v√°lido (formato incorreto, XML corrompido, dados faltando).
2. O sistema retorna um `status: INVALID_OFX` e uma mensagem de erro.

### ‚ö†Ô∏è FE03 - Erro no Processamento das Transa√ß√µes

1. Durante o parsing ou salvamento das transa√ß√µes, ocorre um erro interno (e.g., erro de banco de dados, inconsist√™ncia
   de dados).
2. O sistema retorna um `status: PROCESSING_ERROR` e uma lista de `errors` detalhando as falhas espec√≠ficas.

## üß™ Exemplos de Uso

### Requisi√ß√£o HTTP para Importar um Extrato OFX (conte√∫do abreviado para exemplo)

```http
POST /api/accounts/acc_xyz123/import/ofx HTTP/1.1
Host: api.metakyasshu.com
Content-Type: application/json

{
  "ofxContent": "<OFX><SIGNONMSGSRSV1><SONRS><STATUS><CODE>0</CODE></STATUS>...</OFX>"
  // Conte√∫do real do OFX seria muito mais longo
}
```

### Exemplo de Resposta de Sucesso

```json
{
  "status": "SUCCESS",
  "importedTransactionsCount": 50,
  "duplicateTransactionsCount": 10,
  "message": "Extrato OFX importado com sucesso. 50 novas transa√ß√µes adicionadas, 10 duplicadas ignoradas."
}
```

### Exemplo de Resposta com Erro (OFX Inv√°lido)

```json
{
  "status": "INVALID_OFX",
  "importedTransactionsCount": 0,
  "duplicateTransactionsCount": 0,
  "message": "O arquivo OFX fornecido √© inv√°lido ou est√° corrompido.",
  "errors": ["Erro de parsing na linha X: tag inesperada."]
}
```

---

> ---------------------------------------------------------------------------
> #### üí∞ METAKYASSHU üí∞
> ***Transformando finan√ßas em conquistas compartilhadas***
> --------------------------------------------------------------------------- 